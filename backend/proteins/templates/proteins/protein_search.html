{% extends "base.html" %}
{% load fpbase_tags %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}FPbase: Advanced Fluorescent Protein Search{% endblock %}
{% block meta-description %}Build complex queries to search for fluorescent proteins in FPbase using multiple filters.{% endblock %}

{% block twitter_title %}FPbase: Advanced Fluorescent Protein Search{% endblock twitter_title %}
{% block twitter_description %}Build complex queries to search for fluorescent proteins in FPbase using multiple filters.{% endblock twitter_description %}




{% block extrahead %}
    <link rel="preload" href="{% static 'images/GFP_spinner.gif' %}" as="image">
{% endblock extrahead %}


{% block content %}

<div data-fpbase-init="search"
     data-filter-fields='{{filter_fields|safe}}'
     data-filter-operators='{{filter_operators|safe}}'
     data-filter-labels='{{filter_labels|safe}}'>

<h2>Advanced Protein Search</h2>

<p class="text-muted">Add additional rows to refine your search.  Each row is considered as an 'AND' clause in the search.  If a given search parameter is unknown for a protein in the database, that protein will be excluded from the results. If you find that you are not getting results, relax your query.</p>
<p class='text-muted'>Note: organic dyes are not yet searchable in the database, but spectra for a selection of organic dyes are available on the <a href="{% url 'proteins:spectra' %}">spectra page</a>.</p>

<div class="d-none" id="crispy-form">
 {{ filter.form |crispy }}
</div>

<form action="" method="get" class="mb-2">
    <div id="query_builder">Building form... <img width=60 src="{% static 'images/GFP_spinner.gif' %}"></i></div>
    <div class='clearfix button-row'>
    <button type="submit" class="btn btn-sm btn-primary me-2">{% icon "search" %} Search</button>
    <button type="button" class="btn btn-sm btn-info me-2" id="add-row-btn">{% icon "filter" %} Add Filter</button>

    {% if request.GET %}
    <div class="btn-group float-sm-end displaybuttons mb-3" role="group">
      <input type="radio" class="btn-check" name="display" id="lbutton" autocomplete="off" checked value='l'>
      <label class="btn btn-outline-info btn-sm" for="lbutton">{% icon "grid" %} display blocks</label>

      <input type="radio" class="btn-check" name="display" id="tbutton" autocomplete="off" value='t'>
      <label class="btn btn-outline-info btn-sm" for="tbutton">{% icon "table" %} display table</label>
    </div>
    </div>
    {% endif %}
</form>


    {% if request.GET %}
        <div class="d-flex flex-column-reverse flex-sm-row justify-content-between">
            <div class="">
                <h3 style="font-weight: 300">Search Results</h3>
            </div>
            <div class="">
                <form action='{% url 'proteins:newcollection' %}' method='post' class='float-sm-end'>
                    {% csrf_token %}
                    {%for p in filter.qs %}
                        <input type="hidden" name="protein" value="{{ p.pk }}">
                    {%endfor%}
                    <button class='btn btn-info btn-sm w-100-xs mb-3' type='submit'>Create collection from results</button>
                </form>
            </div>
        </div>

        <div class="container protein_results ps-0 pe-0">
            {% if filter.qs %}
                <div id="ldisplay" {% if request.GET.display == 't' %}class="d-none"{% endif %}>
                {% with proteins=filter.qs %}
                    {% include '_proteinlozenges.html' %}
                {% endwith %}
                </div>
                <div id="tdisplay" class="{% if request.GET.display == 'l' or not request.GET.display %}d-none{% endif %}">
                {% with proteins=filter.qs %}
                    <div class="table-responsive">
                      {% include '_proteintable.html' %}
                    </div>
                {% endwith %}
                </div>
            {% else %}
                {% if filter.recs %}
                    <p>There were no exact results, but the following proteins were similar to your query:</p>

                    <div id="ldisplay" {% if request.GET.display == 't' %}class="d-none"{% endif %}>
                    {% with proteins=filter.recs %}
                        {% include '_proteinlozenges.html' %}
                    {% endwith %}
                    </div>
                    <div id="tdisplay" class="{% if request.GET.display == 'l' or not request.GET.display %}d-none{% endif %}">
                    {% with proteins=filter.recs %}
                        <div class="table-responsive">
                          {% include '_proteintable.html' %}
                        </div>
                    {% endwith %}
                    </div>

                {% else %}
                <div>
                <p>No results found... consider adding it!</p>
                <a href="{% url 'proteins:submit' %}"><button type='button' class="btn btn-primary">Submit a new protein</button></a>
                </div>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}

</div><!-- end data-fpbase-init -->
{% endblock %}
